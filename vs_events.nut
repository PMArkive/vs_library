//-----------------------------------------------------------------------
//------------------- Copyright (c) samisalreadytaken -------------------
//                       github.com/samisalreadytaken
//-----------------------------------------------------------------------
local VERSION = "2.43.12",
ROOT=::getroottable(),CONST=::getconsttable();if("VS"in ROOT){local gVS=::VS;if(typeof gVS=="table"){if(gVS.version==VERSION){if(!(0 in gVS))gVS[0]<-0;if((gVS[0]&0x10)==0x10)return}}}else::VS<-{};;local VS={[0]=0x10,version=VERSION}if(::print.getinfos().native)::Msg<-::print;;if(::EntFireByHandle.getinfos().native)::DoEntFireByInstanceHandle<-::EntFireByHandle;;local AddEvent=::DoEntFireByInstanceHandle,Fmt=::format;VS.GetCaller<-function():(getstackinfos)return getstackinfos(3).locals["this"];VS.MakePersistent<-function(e){return e.__KeyValueFromString("classname","soundent")}VS.GetAllPlayers<-function():(Entities){local e,a=[];while(e=Entities.FindByClassname(e,"player"))a.append(e.weakref());e=null;while(e=Entities.FindByClassname(e,"cs_bot"))a.append(e.weakref());return a}VS.GetPlayerByIndex<-function(i){local e;while(e=Entities.FindByClassname(e,"player"))if(e.entindex()==i)return e;e=null;while(e=Entities.FindByClassname(e,"cs_bot"))if(e.entindex()==i)return e}local Events=delegate::VS:{m_hProxy=null,m_bFixedUp=false,m_SV=null,m_Players=null,m_ppCache=null,m_pSpawner=null,m_pListeners=null,s_szEventName=null,s_hListener=null,s_fnSynchronous=null,__rem=null,__tmp=null,m_DeferredReg=null,Msg=Msg}VS.Events<-Events;if(!("{847D4B}"in ROOT))ROOT["{847D4B}"]<-array(64);;local gED=ROOT["{847D4B}"];VS.GetPlayerByUserid<-function(i):(Entities){if(i in m_Players)return m_Players[i];if(!m_Players)m_Players={};local p;while(p=Entities.FindByClassname(p,"player")){local s=p.GetScriptScope();if("userid"in s&&s.userid==i){m_Players[i]<-p.weakref();return p}}p=null;while(p=Entities.FindByClassname(p,"cs_bot")){local s=p.GetScriptScope();if("userid"in s&&s.userid==i){m_Players[i]<-p.weakref();return p}}}.bindenv(VS.Events);local OnPlayerConnect=function(ev):(gED,ROOT,SendToConsole){if(ev.networkid!=""){local idx;foreach(i,v in gED)if(!gED[i]){idx=i;break};if(idx==null){for(local i=32;i<64;++i){gED[i-32]=gED[i];gED[i]=null}idx=32;Msg("VS::OnPlayerConnect: ERROR!!! Player data is not being processed\n")};gED[idx]=ev;return};if(m_SV){local sc=m_SV.remove(0);if(!sc||!("self"in sc))return Msg("VS::Events: invalid scope in validation\n");if(!sc.__vrefs||!sc.self||!sc.self.IsValid())return Msg("VS::Events: invalid entity in validation\n");if("userid"in sc&&sc.userid!=ev.userid&&sc.userid!=-1)Msg("VS::Events: ERROR!!! conflict! ["+sc.userid+", "+ev.userid+"]\n");if(ev.userid in m_Players&&m_Players[ev.userid]!=sc.self)Msg("VS::Events: ERROR!!! conflict! ["+sc.self+", "+m_Players[ev.userid]+"]\n");sc.userid<-ev.userid;if(!("name"in sc))sc.name<-"";if(!("networkid"in sc))sc.networkid<-"";SendToConsole("banid 0.05 "+ev.userid);if(!(0 in m_SV))m_SV=null}}.bindenv(VS.Events);VS.Events.OnPlayerBan<-function(ev){if(!ev.userid||ev.kicked)return;local ply=GetPlayerByUserid(ev.userid);if(!ply)return Msg("VS::Events: validation failed to find player! ["+ev.userid+"]\n");local sc=ply.GetScriptScope();if(sc.name!=""&&sc.name!=ev.name)Msg(format("VS::Events: validation: [%d] overwriting name '%s' -> '%s'\n",ev.userid,sc.name,ev.name));if(sc.networkid!=""&&sc.networkid!=ev.networkid)Msg(format("VS::Events: validation: [%d] overwriting networkid '%s' -> '%s'\n",ev.userid,sc.networkid,ev.networkid));sc.name=ev.name;sc.networkid=ev.networkid}.bindenv(VS.Events);local OnPlayerSpawn=function(ev):(gED,Fmt,ROOT){foreach(i,v in gED){if(!v)return;if(v.userid==ev.userid){local player=GetPlayerByIndex(v.index+1);if(!player||!player.ValidateScriptScope()){gED[i]=null;Msg("VS::OnPlayerConnect: invalid player entity ["+v.userid+"] ["+(v.index+1)+"]\n");return};local sc=player.GetScriptScope();if("networkid"in sc&&sc.networkid!=""){Msg("VS::OnPlayerConnect: ERROR!!! Something has gone wrong! ");if(sc.networkid==v.networkid){gED[i]=null;Msg(Fmt("Duplicated v. [%d]\n",v.userid))}else Msg(Fmt("Conflicting v. [%d] ('%s', '%s')\n",v.userid,sc.networkid,v.networkid));return};sc.userid<-v.userid;sc.name<-v.name;sc.networkid<-v.networkid;gED[i]=null;gED.sort();gED.reverse();return}}}.bindenv(VS.Events);VS.ForceValidateUserid<-function(p,I=0):(AddEvent,Fmt,Entities){if(!I)Msg("Warning: VS::ForceValidateUserid is deprecated!\n");if(!p||!p.IsValid()||(p.GetClassname()!="player")||!p.ValidateScriptScope())return Msg(Fmt("VS::ForceValidateUserid: invalid input: %s\n",""+p));if(!m_SV)m_SV=[];local sc=p.GetScriptScope(),b=1;foreach(v in m_SV)if(v==sc){b=0;break};if(b)m_SV.append(sc.weakref());if(!m_hProxy){local h=Entities.CreateByClassname("info_game_event_proxy");h.__KeyValueFromString("event_name","player_connect");MakePersistent(h);m_hProxy=h.weakref()};return AddEvent(m_hProxy,"GenerateGameEvent","",0,p,null)}.bindenv(VS.Events);VS.ValidateUseridAll<-function(){Msg("Warning: VS::ValidateUseridAll is deprecated!\n");if(Events.m_bFixedUp){foreach(i,v in GetAllPlayers())if(!("userid"in v.GetScriptScope()))ForceValidateUserid(v)}else{Msg("Warning: VS::ValidateUseridAll: incorrect eventlistener setup!\n");local t=::FrameTime();foreach(i,v in GetAllPlayers())DoEntFireByInstanceHandle(v,"RunScriptCode","VS.ForceValidateUserid(self)",i*t,v,v)}}VS.FixupEventListener<-function(p){if(!p||!p.IsValid()||(p.GetClassname()!="logic_eventlistener")||!p.ValidateScriptScope())return Msg("VS::FixupEventListener: invalid event listener input\n");local sc=p.GetScriptScope();if(sc.parent.rawin("{7D6E9A}"))return Msg("VS::FixupEventListener: already fixed up "+p+"\n");local c=[];sc.rawdelete("event_data");if(!m_ppCache)m_ppCache=[];m_ppCache.append(c.weakref());delegate(delegate(delegate sc.parent:{_delslot=function(k){delete parent.parent[k]}}):{_newslot=function(k,v):(c){if(k=="event_data")return c.insert(0,v);return rawset(k,v)},_get=function(k):(c){if(k=="event_data")return c.pop();return rawget(k)},["{7D6E9A}"]=null}):sc}local __RemovePooledString=function(sz){__rem=sz;m_pSpawner.SpawnEntity();__rem=null}.bindenv(VS.Events);VS.Events.SpawnEntity<-function(ev):(Entities){if(!m_pSpawner){local p=Entities.CreateByClassname("env_entity_maker");p.__KeyValueFromString("EntityTemplate","vs.eventlistener");MakePersistent(p);m_pSpawner=p.weakref()};s_szEventName=ev;m_pSpawner.SpawnEntity();local r=s_hListener;s_szEventName=s_hListener=null;return r}local __ExecutePreSpawn=function(pEnt){local vs=VS.Events;if(vs.__rem){pEnt.__KeyValueFromString("targetname",vs.__rem);pEnt.__KeyValueFromString("EventName","player_connect");pEnt.Destroy();return};if(!vs.s_szEventName){pEnt.Destroy();return Msg("VS::Events::PreSpawn: invalid call origin\n")};pEnt.__KeyValueFromString("EventName",vs.s_szEventName);pEnt.__KeyValueFromInt("FetchEventData",1);pEnt.__KeyValueFromInt("IsEnabled",1);pEnt.__KeyValueFromInt("TeamNum",-1);__EntityMakerResult={}}local __FinishSpawn=function(){__EntityMakerResult=null}local PostSpawn=function(pp){foreach(p in pp){s_hListener=p;FixupEventListener(p);MakePersistent(p);local sc=p.GetScriptScope();if(!s_fnSynchronous){local s=sc.__vname;local i=s.find("_");s=s_szEventName+"_"+s.slice(0,i);p.__KeyValueFromString("targetname",s);p.__KeyValueFromString("OnEventFired",s+",CallScriptFunction,OnEventFired");sc.OnEventFired<-null}else{m_ppCache.pop();p.__KeyValueFromString("targetname","");delete sc.parent._get;sc.parent._newslot=function(k,v):(s_fnSynchronous){if(k=="event_data")return s_fnSynchronous(v);return rawset(k,v)}}}}.bindenv(VS.Events);local OnPostSpawn=function():(__RemovePooledString,OnPlayerConnect,OnPlayerSpawn){local VS=VS;if(!VS.Events.m_bFixedUp){VS.Events.m_bFixedUp=true;Msg("VS::Events init '"+VS.version+"'\n");VS.StopListeningToAllGameEvents("VS::Events");VS.ListenToGameEvent("player_connect",OnPlayerConnect,"VS::Events");VS.ListenToGameEvent("player_spawn",OnPlayerSpawn,"VS::Events");VS.ListenToGameEvent("server_addban",VS.Events.OnPlayerBan,"VS::Events");VS.ListenToGameEvent("player_activate",function(ev){foreach(i,v in GetAllPlayers()){local t=v.GetScriptScope();if(!("userid"in t)||t.userid==-1)ForceValidateUserid(v,1)}}.bindenv(VS),"VS::Events");VS.ListenToGameEvent("player_disconnect",function(ev){if(m_Players&&ev.userid in m_Players)delete m_Players[ev.userid]}.bindenv(VS.Events),"VS::Events");if(VS.Events.m_DeferredReg){foreach(p in VS.Events.m_DeferredReg)VS.ListenToGameEvent.pacall(p);VS.Events.m_DeferredReg=null}};if(VS.Events.__tmp)__RemovePooledString(VS.Events.__tmp);VS.Events.__tmp=__vname}VS.ListenToGameEvent<-function(ev,fn,ctx){local err;if((typeof fn!="function")&&(typeof fn!="native function"))err="invalid callback param";if(typeof ctx!="string")err="invalid context param";if(typeof ev!="string")err="invalid eventname param";if(err){Msg(format("\nAN ERROR HAS OCCURED [%s]\n",err));return PrintStack()};if(!m_pListeners)m_pListeners={};if(!(ev in m_pListeners))m_pListeners[ev]<-{};local pp=m_pListeners[ev];if(!(ctx in pp))pp[ctx]<-null;if(!m_bFixedUp){if(!m_DeferredReg)m_DeferredReg=[];m_DeferredReg.append([this,ev,fn,ctx]);return};local p=pp[ctx];if(!p){if(ctx=="VS::Events")s_fnSynchronous=fn;else s_fnSynchronous=null;if(!(p=SpawnEntity(ev)))return Msg("VS::ListenToGameEvent: ERROR!!! NULL ent!\n");pp[ctx]=p.weakref();if(s_fnSynchronous){s_fnSynchronous=null;return}};p.GetScriptScope().OnEventFired<-function():(fn)return fn(event_data)}.bindenv(VS.Events);VS.StopListeningToAllGameEvents<-function(ctx):(__RemovePooledString){if(m_pListeners)foreach(pp in m_pListeners)if(ctx in pp){local p=pp[ctx];if(p&&(typeof p=="instance")&&p.IsValid())p.Destroy();delete pp[ctx]}}.bindenv(VS.Events);VS.Events.InitTemplate<-function(sc):(__ExecutePreSpawn,__FinishSpawn,PostSpawn,OnPostSpawn){local self;if(!("self"in sc)||!(self=sc.self)||!self.IsValid()||self.GetClassname()!="point_template")throw"VS::Events::InitTemplate: invalid entity";self.__KeyValueFromInt("spawnflags",0);self.__KeyValueFromString("targetname","vs.eventlistener");sc.__EntityMakerResult<-null;sc.__ExecutePreSpawn<-__ExecutePreSpawn;sc.__FinishSpawn<-__FinishSpawn;sc.PreSpawnInstance<-1;sc.PostSpawn<-PostSpawn;sc.OnPostSpawn<-OnPostSpawn.bindenv(sc);if(m_ppCache){for(local i=m_ppCache.len();i--;){local v=m_ppCache[i];if(v)v.clear();else m_ppCache.remove(i)}};if("EventQueue"in VS)VS.EventQueue.Clear()}{local gVS=::VS,T;if("version"in gVS){local pV1=split(gVS.version,"."),pV2=split(VS.version,".");if(!((2 in pV1)&&(2 in pV2)))return;local s=function(p){local x=p[0].len();while(0<=--x){local c=p[0][x];if(c>'9'||c<'0'){p[0]=p[0].slice(x,p[0].len());break}}x=0;for(local i=p.len()-1,l=p[i].len();++x<l;){local c=p[i][x];if(c>'9'||c<'0'){p[i]=p[i].slice(0,x);break}}}s(pV1);s(pV2);local l1=pV1.len(),l2=pV2.len();if(l2>l1){pV1.resize(l2,0);l1=l2}else if(l2<l1)pV2.resize(l1,0);;local x=0;do{local v1=pV1[x].tointeger(),v2=pV2[x].tointeger();if(v2!=v1){T=v2>v1;break}}while(++x<l1);if(T==null)if((gVS[0]&VS[0])==VS[0])return};if(T==null){foreach(k,v in VS)gVS.rawset(k,v);print(format("VS v%s [%Xh]\n",gVS.version,gVS[0]))}else{local n=gVS[0]|VS[0];print(format("VS v%s [%Xh] %d(%Xh|%Xh)\n",gVS.version,n,T.tointeger(),gVS[0],VS[0]));if(T){foreach(k,v in VS){if(k=="Events")continue;gVS.rawset(k,v)}}else{foreach(k,v in VS)if(!(k in gVS)){if(k=="Events")continue;gVS.rawset(k,v)}};gVS[0]=n};VS=null;return collectgarbage()}
